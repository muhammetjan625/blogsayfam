<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title id="post-title">Yükleniyor...</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
    <header class="header">
        <a class="brand" href="index.html">Sessiz Düşünceler</a>
        <nav>
            <a href="admin.html">GİRMEK TEHLİKELİ</a>
            <button id="theme-toggle" class="linklike">Tema Değiştir</button>
        </nav>
    </header>

    <main id="post-content" class="card">
        </main>

    <div class="card comments-section">
        <h2>Yorumlar (<span id="comment-count">0</span>)</h2>
        <div id="comments-list">
            </div>

        <form id="comment-form" class="comment-form">
            <h3>Yorum Bırakın</h3>
            <input class="comment-input" type="text" name="author" placeholder="Adınız" required>
            <textarea class="comment-textarea" name="text" placeholder="Yorumunuzu yazın..." rows="4" required></textarea>
            <button type="submit" class="comment-btn">Gönder</button>
        </form>
    </div>
</div>

<footer class="container footer">
    <p>&copy; <span id="year"></span> Sessiz Düşünceler Blogu</p>
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, doc, addDoc, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // DOĞRU VE EKSİKSİZ FIREBASE KONFİGÜRASYONU
    const firebaseConfig = {
        apiKey: "AIzaSyA-cOHc81SNMX_u0CmpLtnKRS4sNedlN9E",
        authDomain: "blog-sayfa.firebaseapp.com",
        projectId: "blog-sayfa",
        storageBucket: "blog-sayfa.appspot.com",
        messagingSenderId: "610980157440",
        appId: "1:610980157440:web:2409920a6b9ecc28efa0e5",
        measurementId: "G-EF2PN951C7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    document.getElementById('year').textContent = new Date().getFullYear();
    
    // Tema Değiştirme
    document.getElementById('theme-toggle').addEventListener('click', () => {
        const body = document.body;
        body.classList.toggle('light');
        if (body.classList.contains('light')) {
            localStorage.setItem('theme', 'light');
        } else {
            localStorage.setItem('theme', 'dark');
        }
    });

    if (localStorage.getItem('theme') === 'light') {
        document.body.classList.add('light');
    }

    const urlParams = new URLSearchParams(window.location.search);
    const postSlug = urlParams.get('slug');
    const postContentEl = document.getElementById('post-content');
    const postTitleEl = document.getElementById('post-title');
    const commentsListEl = document.getElementById('comments-list');
    const commentCountEl = document.getElementById('comment-count');
    const commentForm = document.getElementById('comment-form');
    let currentPostId = null;

    async function loadPost() {
        if (!postSlug) {
            postContentEl.innerHTML = '<p>Yazı bulunamadı.</p>';
            return;
        }

        const q = query(collection(db, "posts"), where("slug", "==", postSlug));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            postContentEl.innerHTML = '<p>Yazı bulunamadı.</p>';
            return;
        }

        const docSnap = snapshot.docs[0];
        const post = docSnap.data();
        currentPostId = docSnap.id;

        postTitleEl.textContent = post.title;
        document.title = post.title + " - Sessiz Düşünceler";

        postContentEl.innerHTML = `
            ${post.image ? `<img src="${post.image}" alt="${post.title}" class="post-cover-image">` : ''}
            <h1>${post.title}</h1>
            <p class="muted">${post.category || 'Genel'} | ${new Date(post.createdAt?.toDate()).toLocaleDateString()}</p>
            <div class="post-content-body">${post.content}</div>
        `;
        
        loadComments(currentPostId);
    }

    async function loadComments(postId) {
        if (!postId) return;
        
        const q = query(
            collection(db, "comments"),
            where("postId", "==", postId),
            orderBy("createdAt", "desc")
        );
        
        const snapshot = await getDocs(q);
        commentCountEl.textContent = snapshot.size;
        
        commentsListEl.innerHTML = snapshot.docs.map(doc => {
            const c = doc.data();
            const date = c.createdAt ? new Date(c.createdAt.toDate()).toLocaleDateString('tr-TR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';
            return `
                <div class="comment-card">
                    <p class="comment-author">${c.author}</p>
                    <p class="comment-text">${c.text}</p>
                    <p class="comment-date">${date}</p>
                </div>
            `;
        }).join('');
    }

    commentForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const author = commentForm.author.value.trim();
        const text = commentForm.text.value.trim();
        
        if (!author || !text || !currentPostId) {
            alert("Lütfen tüm alanları doldurun.");
            return;
        }

        const newComment = {
            postId: currentPostId,
            author: author,
            text: text,
            createdAt: new Date()
        };
        
        try {
            await addDoc(collection(db, "comments"), newComment);
            commentForm.reset();
            loadComments(currentPostId);
        } catch (error) {
            console.error("Yorum eklenirken bir hata oluştu: ", error);
            alert("Yorum gönderilemedi. Lütfen tekrar deneyin.");
        }
    });

    loadPost();
</script>
</body>
</html>